# 가상 피팅 시스템 사용 가이드

## 📋 개요

가상 피팅 시스템은 사용자가 업로드한 이미지에 추천 코디를 실제로 합성하여 보여주는 기능입니다. Stable Diffusion Inpainting을 사용하여 자연스러운 의류 합성을 제공합니다.

---

## 🎯 구현된 기능

### 1. Stable Diffusion Inpainting 기반 실제 합성 ⭐ 권장
**사용 모델**: `stabilityai/stable-diffusion-2-inpainting`

**작동 방식**:
1. YOLO로 사용자 이미지에서 의류 영역 탐지 (상의/하의)
2. 탐지된 영역을 마스크로 변환
3. Stable Diffusion Inpainting으로 해당 영역을 새로운 의류로 교체
4. 자연스러운 조명, 그림자, 질감까지 생성

**장점**:
- ✅ 실제 의류 질감/형태 반영
- ✅ 자연스러운 조명/그림자
- ✅ 높은 퀄리티

**단점**:
- ⏱️ 느림 (아이템당 약 20-30초)
- 💾 첫 실행 시 모델 다운로드 (약 5GB)
- ⚠️ 색상 정확도 한계 (Stable Diffusion 특성)

### 2. 색상 오버레이 (폴백)
**사용 라이브러리**: OpenCV, NumPy

**작동 방식**:
1. YOLO로 의류 영역 탐지
2. 원본 밝기를 유지하면서 목표 색상으로 변경
3. Alpha blending으로 자연스럽게 합성

**장점**:
- ⚡ 매우 빠름 (<1초)
- 🎯 색상 100% 정확
- 💾 추가 다운로드 불필요

**단점**:
- ❌ 단순한 색상 변경만 가능
- ❌ 질감/형태 변경 불가
- ❌ 조명/그림자 생성 안 됨

---

## 🚀 사용 방법

### 1. 앱 실행
```bash
cd /Users/jimin/opensw/FItzy_copy
source fitzy_env/bin/activate
streamlit run app.py
```

### 2. 이미지 업로드
**중요**: 사람이 옷을 입고 있는 이미지를 업로드해야 합니다.

**권장 이미지**:
- ✅ 전신 사진 (얼굴부터 발까지)
- ✅ 정면을 향한 자세
- ✅ 밝은 조명
- ✅ 단순한 배경
- ✅ 상의/하의가 명확히 구분됨

**피해야 할 이미지**:
- ❌ 얼굴만 나온 사진
- ❌ 복잡한 배경
- ❌ 어두운 조명
- ❌ 측면/뒷모습
- ❌ 의류가 겹쳐진 경우

### 3. 결과 확인
- **추천 코디 1**: 자동으로 가상 피팅 이미지 생성
- **추천 코디 2, 3**: "🎨 {스타일} 스타일 가상 피팅 생성" 버튼 클릭으로 생성
- 각 이미지 아래에 "📝 사용된 프롬프트 보기" expander로 프롬프트 확인 가능
- 처리 시간: Inpainting 모드 약 9-10초 (아이템당, MPS 기준), 색상 오버레이 모드 <1초
- "이 조합이 어울리는 이유" 섹션에서 MBTI, 계절, 날씨 등을 연계한 상세 설명 확인
- "현재 코디 평가" 섹션에서 추천 이유와 연계된 평가 확인

---

## 🔧 기술 세부 사항

### 사용 중인 라이브러리

| 라이브러리 | 용도 | 버전 |
|-----------|------|------|
| **diffusers** | Stable Diffusion Inpainting | 0.35.2 |
| **OpenCV** | 이미지 처리, 색상 블렌딩 | 4.12 |
| **NumPy** | 배열 연산 | 1.26.4 |
| **PIL (Pillow)** | 이미지 입출력 | 11.3.0 |
| **PyTorch** | 딥러닝 프레임워크 | 2.8.0 |

### 가상 피팅 파이프라인

```
사용자 이미지 업로드
         ↓
YOLO 의류 영역 탐지
         ↓
바운딩박스 → 마스크 변환
         ↓
Inpainting 프롬프트 생성
         ↓
SD Inpainting 실행
(해당 영역만 교체)
         ↓
자연스러운 합성 결과
```

### Inpainting 파라미터

```python
self.inpaint_pipe(
    prompt="a {gender} wearing a {color} {type}, EXACTLY {color} color, {fabric} fabric, realistic fit, naturally worn, proper draping, natural folds, realistic lighting, natural shadows, high quality photo, professional photography, authentic clothing texture",
    negative_prompt="face, head, portrait, person, wrong colors, blurry, ...",
    image=original_image,      # 원본 이미지
    mask_image=mask,            # 교체할 영역 (흰색)
    num_inference_steps=11,     # DPM Solver 사용 (MPS 기준, CPU는 7)
    guidance_scale=7.5,         # 프롬프트 준수도
    strength=0.85               # 85% 변경, 15% 원본 유지
)
```

**반환값**:
- `(이미지, 프롬프트 정보)` 튜플
- 프롬프트 정보: 각 영역(상의/하의)별 프롬프트 포함

---

## ⚠️ 알려진 한계

### 1. YOLO 탐지 정확도
- 의류가 명확히 구분되지 않으면 탐지 실패
- 복잡한 패턴/겹침은 탐지 어려움

### 2. Inpainting 색상 정확도
- Stable Diffusion의 색상 표현 한계
- 약 70-80% 정확도 (완벽하지 않음)

### 3. 처리 속도
- Inpainting: 아이템당 약 9-10초 (MPS 기준, 11 inference steps)
- CPU 모드: 아이템당 약 7-8초 (7 inference steps)
- 추천 코디 1만 자동 생성되므로 초기 로딩 시간 단축
- 추천 코디 2, 3은 버튼 클릭 시에만 생성 (필요 시에만 처리)

### 4. 메모리 사용
- Inpainting 모델: 약 5GB
- M2 MacBook 8GB에서 안정적으로 작동

---

## 💡 대안 모델 검토 결과

### 검토한 무료 Virtual Try-On 모델

| 모델 | 정확도 | 속도 | M2 호환 | 구현 난이도 | 상태 |
|------|--------|------|---------|------------|------|
| **VITON** | ⭐⭐⭐⭐ | ⭐⭐ | ⚠️ | ⭐⭐⭐⭐ | 복잡함 |
| **CP-VTON** | ⭐⭐⭐⭐⭐ | ⭐⭐ | ⚠️ | ⭐⭐⭐⭐⭐ | 매우 복잡 |
| **HR-VITON** | ⭐⭐⭐⭐⭐ | ⭐ | ⚠️ | ⭐⭐⭐⭐⭐ | 매우 복잡 |
| **TryOnGAN** | ⭐⭐⭐⭐ | ⭐⭐ | ❌ | ⭐⭐⭐⭐ | GPU 필요 |
| **SD Inpainting (DPM Solver)** | ⭐⭐⭐ | ⭐⭐⭐⭐ | ✅ | ⭐⭐ | **현재 사용** |

### 결론
- **현재 최선**: Stable Diffusion Inpainting (DPM Solver 스케줄러)
  - M2 MacBook에서 안정적으로 작동
  - 구현이 간단함
  - 무료
  - 합리적인 품질
  - PNDM 스케줄러 오류 해결

- **더 나은 품질을 위해서는**:
  - VITON/CP-VTON 등 전문 모델 필요
  - 복잡한 구현 및 GPU 서버 필요
  - 현재 환경에서는 비실용적

---

## 🎨 실사용 예시

### 케이스 1: 성공적인 합성
**입력**:
- 이미지: 사람이 파란 셔츠를 입은 전신 사진
- 추천 코디: "빨간색 긴팔 셔츠", "검은색 바지"

**결과**:
- 상의 영역이 빨간색 긴팔 셔츠로 교체됨
- 하의 영역은 유지 (1개 아이템만 처리로 속도 우선)
- 처리 시간: 약 25초

### 케이스 2: 탐지 실패
**입력**:
- 이미지: 복잡한 배경, 의류 구분 안 됨

**결과**:
- "의류 영역을 찾을 수 없습니다" 경고
- 원본 이미지에 추천 코디 텍스트만 오버레이

---

## 🔍 트러블슈팅

### "의류 영역을 찾을 수 없습니다"
**원인**: YOLO가 의류를 탐지하지 못함

**해결**:
1. 전신 사진 업로드
2. 밝은 조명의 이미지 사용
3. 단순한 배경의 이미지 사용
4. 진단 모드로 YOLO 탐지 결과 확인

### "Inpainting 실패"
**원인**: 모델 로드 실패 또는 메모리 부족

**해결**:
1. 자동으로 색상 오버레이 모드로 폴백됨
2. 다른 앱 종료하여 메모리 확보
3. 모델 재다운로드 시도

### 색상이 정확하지 않음
**원인**: Stable Diffusion의 색상 표현 한계

**해결**:
1. 현재는 최선의 최적화가 적용된 상태
2. 더 나은 색상 정확도를 위해서는 전문 Virtual Try-On 모델 필요
3. 참고용으로 사용

---

## 📊 성능 비교

| 항목 | SD Inpainting (현재) | 색상 오버레이 (폴백) |
|------|---------------------|-------------------|
| **속도** | ⭐⭐⭐⭐ (9-10초, MPS) | ⭐⭐⭐⭐⭐ (<1초) |
| **색상 정확도** | ⭐⭐⭐ (70-80%) | ⭐⭐⭐⭐⭐ (100%) |
| **질감 표현** | ⭐⭐⭐⭐ (자연스러움) | ⭐ (없음) |
| **얼굴 유지** | ⭐⭐⭐⭐⭐ (완벽) | ⭐⭐⭐⭐⭐ (완벽) |
| **메모리** | 5GB | <100MB |
| **프롬프트 표시** | ⭐⭐⭐⭐⭐ (각 영역별 표시) | - |

---

## 🚀 향후 개선 방향

### 단기
1. ✅ Inpainting 통합 (완료)
2. ✅ DPM Solver 스케줄러 적용 (완료)
3. ✅ 스텝 수 최적화 (12 → 11 steps for MPS, 7 steps for CPU, 완료)
4. ✅ 프롬프트 정보 반환 및 표시 (완료)
5. ✅ 추천 코디 1 자동 생성, 2와 3 버튼 클릭 (완료)
6. ⬜ 2개 아이템 동시 처리 (현재 1개만)
7. ⬜ 캐싱 최적화

### 중기
1. ⬜ Segmentation 기반 정밀 마스킹
2. ⬜ ControlNet 통합 (형태 정밀 제어)
3. ⬜ 조명 자동 매칭

### 장기
1. ⬜ 전문 Virtual Try-On 모델 (VITON/CP-VTON)
2. ⬜ 3D 포즈 인식
3. ⬜ 실시간 처리

---

## 📝 사용자 안내 문구

앱에 표시할 권장 안내:

```
✅ 가상 피팅 모드 (업로드 이미지에 추천 코디 합성)

💡 최상의 결과를 위한 팁:
- 전신 사진을 업로드하세요
- 정면을 향한 자세가 좋습니다
- 밝은 조명의 이미지를 사용하세요
- 단순한 배경이 이상적입니다

⏱️ 처리 시간: 약 9-10초 (아이템당, MPS 기준)
🎨 실제 의류 질감까지 자연스럽게 합성됩니다
📝 각 이미지에 사용된 프롬프트를 확인할 수 있습니다
```

---

**작성일**: 2025-01-11  
**모델**: Stable Diffusion 2 Inpainting (DPM Solver Multistep Scheduler)  
**환경**: M2 MacBook, 8GB Memory
**최적화**: 11 inference steps (MPS), 7 inference steps (CPU), guidance_scale 7.5
**주요 변경사항**:
- 프롬프트 정보 반환 및 표시 기능 추가
- 추천 코디 1 자동 생성, 2와 3 버튼 클릭으로 변경
- 공통 유틸리티 사용 (색상 변환, 디바이스 설정)
- IndexError 해결 (스텝 수 조정)

